# The container definition we want to use for developing our app
box: node:5.6.0-slim
# Defining the dev pipeline
dev:
  steps:
    - npm-install
    - internal/watch:
        code: node server.js
        reload: true

# Build definition
build:
  # The steps that will be executed on build
  steps:
    - script:
        code: export NODE_ENV='production'
    # A step that executes `npm install` command
    - npm-install
    # A step that executes `npm test` command
    - npm-test

    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

    # Create gcloud-playground-controller.json only for initialization
    # - script:
    #     name: create gcloud-playground-controller.json
    #     code: ./create-gcloud-playground-controller.json.sh

    # Copy files to a location that gets passed along to the deploy pipeline
    - script:
        name: copy files
        code: cp server.js package.json "$WERCKER_OUTPUT_DIR"

deploy:
  steps:
  # Use the scratch step to build a container from scratch based on the files present
  - internal/docker-scratch-push:
      username: $QUAY_USERNAME
      password: $QUAY_PASSWORD
      cmd: node server.js
      tag: $WERCKER_GIT_COMMIT
      ports: "8080"
      repository: quay.io/gg_dh/gcloud-playground
      registry: https://quay.io